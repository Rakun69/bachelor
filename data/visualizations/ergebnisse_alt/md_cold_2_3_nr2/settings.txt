#!/usr/bin/env bash
set -euo pipefail

READING_COUNTS=${1:-"400,420,440,460,480,500,520,540,560,580,600,620,640,660,680,700,720,740,760,780,800"}
IMAGE_NAME=iot-zk-snark-eval
HOST_PROJECT_DIR="/home/ramon/bachelor"
CONTAINER_PROJECT_DIR="/app"

echo "[INFO] Building Docker image ${IMAGE_NAME}..."
docker build --no-cache -t ${IMAGE_NAME} .

echo "[INFO] Running container..."
docker run --rm \
  --cpus=4 \
  --memory=4g \
  --memory-swap=4g \
  -v "${HOST_PROJECT_DIR}:${CONTAINER_PROJECT_DIR}" \
  -w "${CONTAINER_PROJECT_DIR}" \
  ${IMAGE_NAME} \
  bash -c " \
    python3 -c \"import numpy; print('NumPy version:', numpy.__version__)\" && \
    python3 scripts/measure_crossover_real.py \
      --reading-counts ${READING_COUNTS} \
      --warmup-runs 2 \
      --repetitions 3 \
      --mode cold \
  "

echo "[INFO] Done."
